
<img src="https://img.shields.io/badge/HARD-darkred" alt="HARD" width="70">

ğŒğ®ğ¬ğ­ ğ“ğ«ğ²: Amazon (Hard Level) hashtag#SQL Interview Question â€” Solution

Find the best selling item for each month (no need to separate months by year) where the biggest total invoice was paid. The best selling item is calculated using the formula (unitprice * quantity). Output the month, the description of the item along with the amount paid.

ğŸŒ€ Definitely you are going to enjoy by solving this, you'll learn how to use multiple CTE and windows functions. Give it a try and share the output! ğŸ‘‡

ğ’ğœğ¡ğğ¦ğš ğšğ§ğ ğƒğšğ­ğšğ¬ğğ­
CREATE TABLE online_retail (invoiceno VARCHAR(50),stockcode VARCHAR(50),description VARCHAR(255),quantity INT,invoicedate DATETIME,unitprice FLOAT,customerid FLOAT,country VARCHAR(100));

INSERT INTO online_retail (invoiceno, stockcode, description, quantity, invoicedate, unitprice, customerid, country)VALUES('536365', '85123A', 'WHITE HANGING HEART T-LIGHT HOLDER', 10, '2021-01-15 10:00:00', 2.55, 17850, 'United Kingdom'),('536366', '71053', 'WHITE METAL LANTERN', 5, '2021-02-10 12:00:00', 3.39, 13047, 'United Kingdom'),('536367', '84406B', 'CREAM CUPID HEARTS COAT HANGER', 8, '2021-03-05 15:00:00', 2.75, 17850, 'United Kingdom'),('536368', '22423', 'REGENCY CAKESTAND 3 TIER', 2, '2021-04-12 16:30:00', 12.75, 13047, 'United Kingdom'),('536369', '85123A', 'WHITE HANGING HEART T-LIGHT HOLDER', 15, '2021-05-18 11:00:00', 2.55, 13047, 'United Kingdom'),('536370', '21730', 'GLASS STAR FROSTED T-LIGHT HOLDER', 12, '2021-06-25 14:00:00', 4.25, 17850, 'United Kingdom');

---------

ğ„ğ±ğ©ğ¥ğšğ§ğšğ­ğ¢ğ¨ğ§ ğ­ğ¨ ğ’ğ¨ğ¥ğ¯ğ ğğ®ğğ«ğ²
1. MonthlySales CTE: Calculates the total sales (unitprice * quantity) for each item (description) grouped by the month (MONTH(invoicedate)).
SUM aggregates the total sales for each item in a given month.

2. RankedSales CTE: Assigns a RANK() to each item within each month based on the total_sales in descending order. RANK() ensures the top-selling item in terms of sales amount is identified for each month.

3. Final Query: Filters to return only the best-selling item for each month (sales_rank = 1).

**SOLUTION**
```sql
WITH MonthlySales AS (
	SELECT 
		EXTRACT(MONTH FROM invoicedate) AS month,
        description,
        ROUND(SUM(quantity * unitprice), 2) AS total_Sales
        FROM meta.online_retail
        GROUP BY month, description
),
RankedSales AS (
	SELECT 
		month, description, total_sales,
        DENSE_RANK() OVER (PARTITION BY month ORDER BY total_sales DESC) AS sales_rank
        FROM MonthlySales
)
SELECT 
	month, description, total_sales
    FROM RankedSales
    WHERE sales_rank = 1
    ORDER BY month ASC;
```

<img width="788" height="233" alt="image" src="https://github.com/user-attachments/assets/394f3756-4b66-48c3-aaa8-7928d7cae04a" />

